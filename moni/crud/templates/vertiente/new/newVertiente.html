{% load static %}
<!DOCTYPE html>
<html lang="es">
    <head>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/admin-lte@3.1/dist/js/adminlte.min.js"></script>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    
        <link rel="stylesheet" href="{% static 'css/crear.css' %}">
        <link rel="stylesheet" href="{% static 'css/Gestion_usuarios.css' %}">
        <link rel="stylesheet" href="{% static 'css/navasi.css' %}">

        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
        <!--extra-->

        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

        
        <style>
            .aviso {
              position: fixed;
              top: 7.5cm; /* 5 cm m치s abajo */
              margin-left: 14cm; /* 4 cm a la derecha */
              background-color: #3393B7;
              color: #FFFFFF;
              padding: 50px;
              border-radius: 30px;
              z-index: 9999;
              font-size: 20px;
              font-family: Arial, sans-serif;
          }.hidden {
    display: none;
}
        </style>
       
    </head>

    <body>
      <div class="vertical-bar">
          <div class="sidebar">
              <ul class="sidebar-nav">
                  <li class="nav-item"><a href="{% url 'crud:select' %}"><div class="icon-on-top"><i class="fas fa-home"></i></div><span>Inicio</span></a></li>
                  <li class="nav-item"><a href="{% url 'crud:mapa_general' %}"><div class="icon-on-top"><i class="fas fa-map"></i></div><span>Mapa</span></a></li>
                  <li class="nav-item"><a href="#"><div class="icon-on-top"><i class="fas fa-chart-bar"></i></div><span>Gr치ficas</span></a></li>
                  <li class="nav-item"><a href="{% url 'crud:index' %}"><div class="icon-on-top"><i class="bi bi-kanban"></i></div><span>Gesti칩n</span></a></li>
                  <li class="nav-item"><a href="{% url 'eva:comuni' %}"><div class="icon-on-top"><i class="fas fa-users"></i></div><span>Comunidad</span></a></li>
                  
              </ul>
          </div>
      </div>
      
      <nav class="navbar">
          <div class="navbar-left">
              <span class="hidro-tech">HidroTech</span>
          </div>
          <div class="navbar-center">
              <div class="admin-box">Vista Administrador</div>
          </div>
          <a href="{% url 'crud:listvert' %}" class="volverr">Volver</a>
          <a href="{% url 'nucleo:logout' %}" class="cerrar-sesion">Cerrar Sesi칩n</a>
      </nav>

      <div class="center-container">
        <div class="vertientes-container">
            <div class="center-div">
                <div class="card-header">
                    <h3 class="card-title">Nueva vertiente</h3>
                </div>
                <div class="contenido-rectangulo">
                    <!-- Formulario -->
                    <div class="form-container" style="width: 50%;">
                        <form method="post" onsubmit="return enviarFormulario();">
                            <div class="card-body">
                                <div class="form-group">
                                    {{ form.errors }}
                                    {% csrf_token %}
                                    {% for field in form.visible_fields %}
                                    
                                    <div class="form-group">
                                        <div class="form-group {% if field.name == 'latitud' or field.name == 'longitud' %}hidden{% endif %}">
                                            <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                                            {{ field }}
                                        </div>
                                        
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            
                            <!-- Hidden input field for 'action' -->
                            <input type="hidden" name="action" value="listo">
                            
                            <div class="card-footer">
                                <button type="submit" onclick="mostrarMensaje()" class="btn btn-success">Crear</button>
                                <a href="{% url 'crud:listvert' %}" class="button">
                                    <button type="button" class="btn btn-danger">Cancelar</button>
                                </a>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Mapa -->
                    <div class="map-container" style="width: 50%;">
                        <div id="map" style="height: 500px;position: relative;margin-right: 20px;border-radius: 15px;"></div>
                        {{ comunidades|json_script:"comunidades_json" }}
                        {{ vertientes|json_script:"vertientes_json" }}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        var lati = -36.084726;
        var longi = -71.217422;
        var map = L.map('map').setView([lati, longi], 11);
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.google.cl/copyright">OpenStreetMap</a>'
        }).addTo(map);

        let vertientes = JSON.parse(document.getElementById('vertientes_json').textContent);
        let comunidades = JSON.parse(document.getElementById('comunidades_json').textContent);
        var currentMarker = null;
        let marcador = null;
        let vmarcador = null;
        var marcadoresGroup = L.layerGroup().addTo(map);
        var marcadoresGroup2 = L.layerGroup().addTo(map);
        var marcadoresGroup3 = L.layerGroup().addTo(map);

        map.on('click', function(event) {
            if (currentMarker) {
                map.removeLayer(currentMarker);
            }

            currentMarker = L.marker([event.latlng.lat, event.latlng.lng]).addTo(map);
            console.log(event.latlng);
            var latlng = event.latlng;
            var latitudField = document.getElementById('id_latitud');
            var longitudField = document.getElementById('id_longitud');

            if (latitudField && longitudField) {
                // Update the fields
                latitudField.value = latlng.lat;
                longitudField.value = latlng.lng;
            } else {
                console.log('xdd');
            }
        });

        comunidades.forEach(comunidad => {
            var icono = L.icon({
                iconUrl: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png',
                iconAnchor: [12, 41],
                popupAnchor: [1, -34]
            });
            marcador = L.marker([comunidad.latitud, comunidad.longitud], { icon: icono }).addTo(marcadoresGroup);
            nombre = comunidad.nombre.toString();
            marcador.bindTooltip('Comunidad: ' + nombre).openTooltip();
        });

        $(function(){
            $('select[name="comunidad"]').on('change', function(){
                var id = $(this).val();
                console.log(id);

                $.ajax({
                    url: window.location.pathname,
                    type: 'POST',
                    data: {
                        'action': 'seaid',
                        'id': id
                    },
                    dataType: 'json'
                }).done(function(data) {
                    console.log('weno');
                    lati = data[0];
                    longi = data[1];
                    map.setView([lati, longi]);

                    comunidades.forEach(comunidad => {
                        marcadoresGroup.clearLayers();
                        var icono = L.icon({
                            iconUrl: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png',
                            iconAnchor: [12, 41],
                            popupAnchor: [1, -34]
                        });
                        if (comunidad.id == id) {
                            if (marcadoresGroup3) {
                                marcadoresGroup3.clearLayers();
                            }
                            console.log('ENTRO');
                            vmarcador = L.marker([comunidad.latitud, comunidad.longitud], { icon: icono }).addTo(marcadoresGroup3);
                            nombre = comunidad.nombre.toString();
                            vmarcador.bindTooltip('Comunidad: ' + nombre).openTooltip();
                        }
                    });
                    marcadoresGroup2.clearLayers();

                    vertientes.forEach(vertiente => {
                        if (vertiente.comunidad_id == id) {
                            var icono = L.icon({
                                iconUrl: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png',
                                iconAnchor: [12, 41],
                                popupAnchor: [1, -34]
                            });
                            marcador = L.marker([vertiente.latitud, vertiente.longitud], { icon: icono }).addTo(marcadoresGroup2);
                            nombre = vertiente.nombre.toString();
                            marcador.bindTooltip('Vertiente: ' + nombre).openTooltip();
                        }
                    });
                }).fail(function(data) {
                    error = data['error'];
                    console.log(error);
                }).always(function(data) {
                    console.log('siempre');
                });
            });
        });
        function mostrarMensaje() {
            var mensaje = document.createElement("div");
            mensaje.className = "aviso";
            mensaje.innerText = "Se ha Creado correctamente la Vertiente";
            document.body.appendChild(mensaje);
        
            // Redirigir a la vista 'crud:listcom' despu칠s de mostrar el mensaje
            setTimeout(function() {
                window.location.href = "{% url 'crud:listcom' %}";
            }, 2000); // 3000 milisegundos = 3 segundos
        }
        function enviarFormulario() {
          mostrarMensaje();
          setTimeout(function() {
            document.forms[0].submit(); // Env칤a el formulario despu칠s de mostrar el mensaje durante 10 segundos
          }, 2000); // 10000 milisegundos = 10 segundos
          return false; // Previene la recarga autom치tica de la p치gina
        }
    </script>
</body>
</html>

